name: Generate Android Keystore

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "App name (apps/<app_name>)"
        required: true
        type: string

      keystore_password:
        description: "Keystore password (leave EMPTY to auto-generate)"
        required: false
        type: string

      key_password:
        description: "Key password (leave EMPTY = same as keystore password)"
        required: false
        type: string

      overwrite:
        description: "Overwrite existing keystore"
        required: false
        default: false
        type: boolean

jobs:
  generate-keystore:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Prepare passwords
        shell: bash
        run: |
          set -e

          if [ -z "${{ inputs.keystore_password }}" ]; then
            GEN_PASS=$(openssl rand -base64 32 | tr -d '=+/')
            echo "::add-mask::$GEN_PASS"
            echo "KEYSTORE_PASSWORD=$GEN_PASS" >> $GITHUB_ENV
          else
            echo "::add-mask::${{ inputs.keystore_password }}"
            echo "KEYSTORE_PASSWORD=${{ inputs.keystore_password }}" >> $GITHUB_ENV
          fi

          if [ -n "${{ inputs.key_password }}" ]; then
            echo "::add-mask::${{ inputs.key_password }}"
            echo "KEY_PASSWORD=${{ inputs.key_password }}" >> $GITHUB_ENV
          fi

      - name: Generate keystore
        env:
          CI: "true"
          APP_NAME: ${{ inputs.app_name }}
        run: |
          ARGS="--ci"
          if [ "${{ inputs.overwrite }}" = "true" ]; then ARGS="$ARGS --overwrite"; fi
          dart generate_keystore.dart $ARGS

      - name: Upload keystore (PRIVATE ONLY)
        uses: actions/upload-artifact@v4
        with:
          name: keystore-${{ inputs.app_name }}
          path: apps/${{ inputs.app_name }}/
