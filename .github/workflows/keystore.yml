name: Generate Android Keystore

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "App name (folder will be created under apps/)"
        required: true
        type: string

      keystore_password:
        description: "Keystore password (strong password recommended)"
        required: true
        type: string

      key_password:
        description: "Key password (leave empty to use keystore password)"
        required: false
        type: string

      verify:
        description: "Verify keystore after generation"
        required: false
        default: false
        type: boolean

      overwrite:
        description: "Overwrite existing app folder if exists"
        required: false
        default: false
        type: boolean

jobs:
  generate-keystore:
    name: Generate Keystore
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Java (for keytool)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3️⃣ Setup Dart
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      # 4️⃣ Generate keystore using your script
      - name: Generate keystore (CI mode)
        env:
          CI: "true"
          APP_NAME: ${{ inputs.app_name }}
          KEYSTORE_PASSWORD: ${{ inputs.keystore_password }}
          KEY_PASSWORD: ${{ inputs.key_password }}
        run: |
          ARGS="--ci"
          if [ "${{ inputs.verify }}" = "true" ]; then
            ARGS="$ARGS --verify"
          fi
          if [ "${{ inputs.overwrite }}" = "true" ]; then
            ARGS="$ARGS --overwrite"
          fi

          echo "Running: dart generate_keystore.dart $ARGS"
          dart generate_keystore.dart $ARGS

      # 5️⃣ (Optional) Upload generated keystore as artifact
      # ⚠️ استخدم هذا فقط مع PRIVATE repo
      - name: Upload keystore artifact (PRIVATE ONLY)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: keystore-${{ inputs.app_name }}
          path: |
            apps/${{ inputs.app_name }}/
          if-no-files-found: error
