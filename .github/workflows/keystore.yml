name: Generate Android Keystore

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "App name (folder will be created under apps/)"
        required: true
        type: string

      keystore_password:
        description: "Keystore password (leave EMPTY to auto-generate)"
        required: false
        type: string

      key_password:
        description: "Key password (leave EMPTY = same as keystore password)"
        required: false
        type: string

      verify:
        description: "Verify keystore after generation"
        required: false
        default: false
        type: boolean

      overwrite:
        description: "Overwrite existing app folder if exists"
        required: false
        default: false
        type: boolean

jobs:
  generate-keystore:
    runs-on: ubuntu-latest
    name: Generate Keystore

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Java (keytool)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3Ô∏è‚É£ Setup Dart
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      # 4Ô∏è‚É£ Generate strong password IF user didn't provide one
      - name: Prepare passwords
        id: passwords
        shell: bash
        run: |
          set -e

          if [ -z "${{ inputs.keystore_password }}" ]; then
            echo "üîê No password provided ‚Äî generating strong password"
            GEN_PASS=$(openssl rand -base64 32 | tr -d '=+/')
            echo "::add-mask::$GEN_PASS"
            echo "KEYSTORE_PASSWORD=$GEN_PASS" >> $GITHUB_ENV
          else
            echo "::add-mask::${{ inputs.keystore_password }}"
            echo "KEYSTORE_PASSWORD=${{ inputs.keystore_password }}" >> $GITHUB_ENV
          fi

          if [ -z "${{ inputs.key_password }}" ]; then
            echo "KEY_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          else
            echo "::add-mask::${{ inputs.key_password }}"
            echo "KEY_PASSWORD=${{ inputs.key_password }}" >> $GITHUB_ENV
          fi

      # 5Ô∏è‚É£ Run your Dart script (CI mode)
      - name: Generate keystore
        env:
          CI: "true"
          APP_NAME: ${{ inputs.app_name }}
        run: |
          ARGS="--ci"
          if [ "${{ inputs.verify }}" = "true" ]; then ARGS="$ARGS --verify"; fi
          if [ "${{ inputs.overwrite }}" = "true" ]; then ARGS="$ARGS --overwrite"; fi

          dart generate_keystore.dart $ARGS

      # 6Ô∏è‚É£ Upload artifact (PRIVATE repos only)
      - name: Upload keystore artifact (PRIVATE ONLY)
        uses: actions/upload-artifact@v4
        with:
          name: keystore-${{ inputs.app_name }}
          path: apps/${{ inputs.app_name }}/
          if-no-files-found: error
