name: Update Keystore History

on:
  workflow_call:
    inputs:
      safe_app:
        required: true
        type: string
      action_type:
        required: true
        type: string

jobs:
  history:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - run: |
          FILE="Keystore_History.md"
          DATE=$(date -u +"%Y-%m-%d %H:%M:%S")
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ ! -f "$FILE" ]; then
            cat <<EOF > $FILE
# ðŸ” Android Keystore History

âš ï¸ Auto-generated. Manual edits forbidden.

---

## ðŸ“œ History Log

| Date (UTC) | App | Action | Actor | Run |
|-----------|-----|--------|-------|-----|
EOF
          fi

          sed -i '/HISTORY_HASH/d' "$FILE"
          echo "| $DATE | ${{ inputs.safe_app }} | ${{ inputs.action_type }} | ${{ github.actor }} | [Run]($RUN_URL) |" >> "$FILE"

          HASH=$(sed -n '/## ðŸ“œ History Log/,/---/p' "$FILE" | sha256sum | awk '{print $1}')
          echo "" >> "$FILE"
          echo "<!-- HISTORY_HASH: $HASH -->" >> "$FILE"
